<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TABACO ‚Äì Compra por WhatsApp</title>

  <style>
    :root{
      --bg:#000;
      --fg:#f5f5f5;
      --gold:#f6c000;
      --border:#222;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--fg);
    }
    header{
      position:sticky;
      top:0;
      z-index:10;
      background:#000;
      border-bottom:1px solid var(--border);
    }
    .header-inner{
      max-width:1100px;
      margin:auto;
      padding:14px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:800;
      letter-spacing:2px;
      color:var(--gold);
    }
    .small-btn{
      background:#111;
      color:#f5f5f5;
      border:1px solid #333;
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:700;
      letter-spacing:.5px;
      font-size:12px;
    }

    main{ max-width:1100px; margin:auto; padding:40px 20px; }
    h2{ text-align:center; letter-spacing:2px; margin-bottom:40px; }

    .products{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:40px;
    }
    .product{
      background:#fff;
      color:#000;
      border-radius:4px;
      padding:20px;
      text-align:center;
    }
    .product img{
      max-width:180px;
      height:auto;
      margin-bottom:16px;
      display:block;
      margin-left:auto;
      margin-right:auto;
    }
    .product-name{ font-size:14px; margin-bottom:6px; }
    .product-price{ font-size:14px; margin-bottom:16px; }

    .qty{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .qty button{
      width:32px;
      height:32px;
      border:1px solid #000;
      background:#fff;
      cursor:pointer;
      font-weight:700;
    }
    .qty span{
      min-width:30px;
      text-align:center;
      font-weight:800;
    }
    .add{
      border:1px solid #000;
      background:#fff;
      padding:8px 14px;
      cursor:pointer;
      font-weight:900;
    }
    .hint{ font-size:12px; opacity:.75; margin-top:10px; }

    .cart{
      margin-top:60px;
      border-top:1px solid var(--border);
      padding-top:30px;
    }
    .cart h3{ text-align:center; margin-bottom:20px; }
    .cart ul{ list-style:none; padding:0; margin:0 0 20px; }
    .cart li{
      display:flex;
      justify-content:space-between;
      margin-bottom:8px;
      font-size:14px;
    }
    .cart-total{
      display:flex;
      justify-content:space-between;
      font-weight:900;
      margin-bottom:20px;
    }
    .buy{
      width:100%;
      padding:14px;
      background:var(--gold);
      border:none;
      font-weight:900;
      cursor:pointer;
    }
    footer{ margin-top:60px; text-align:center; font-size:12px; opacity:.7; }

    .status{
      text-align:center;
      margin:10px 0 0;
      font-size:12px;
      opacity:.8;
    }
  </style>
</head>

<body>
<header>
  <div class="header-inner">
    <div>TABACO</div>
    <button class="small-btn" id="reloadBtn" type="button">Recargar productos</button>
  </div>
</header>

<main>
  <h2>PRODUCTOS</h2>

  <div class="status" id="status"></div>

  <section class="products" id="products"></section>

  <section class="cart">
    <h3>Carrito</h3>
    <ul id="cartList"></ul>
    <div class="cart-total">
      <span>Total</span>
      <span id="cartTotal">$0</span>
    </div>
    <button class="buy" id="buyBtn">INICIAR COMPRA POR WHATSAPP</button>
  </section>

  <footer>
    Compra directa por WhatsApp. No se solicitan datos personales.
  </footer>
</main>

<script>
  // ===== CONFIG =====
  const WHATSAPP_PHONE = "5493515060159";

  // üëâ PEG√Å AC√Å TU LINK CSV PUBLICADO (Google Sheets "Publicar en la web" como CSV)
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRXfu7as7scLMqrv48bHpytzzRwK0VlgPfVrOJ_3MsqnNBzfC0TRjsfO52HSsVjMkAzWJaGvcMh12Hv/pub?output=csv";

  // ===== STATE =====
  let products = [];          // viene del Sheet
  let cart = {};              // {id: qty}
  let pending = {};           // {id: qtyPendiente} (para tu UX: + / - no agrega hasta tocar AGREGAR)

  const productsEl = document.getElementById("products");
  const cartList = document.getElementById("cartList");
  const cartTotal = document.getElementById("cartTotal");
  const buyBtn = document.getElementById("buyBtn");
  const reloadBtn = document.getElementById("reloadBtn");
  const statusEl = document.getElementById("status");

  // ===== HELPERS =====
  const fmt = (n) => n.toLocaleString("es-AR");
  const money = (n) => `$${fmt(n)}`;

  // CSV robusto (soporta comillas y comas dentro)
  function parseCSV(text){
    // normaliza saltos
    text = text.replace(/\r/g, "");
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++){
      const ch = text[i];

      if (ch === '"'){
        // doble comilla dentro de comillas => "
        if (inQuotes && text[i+1] === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if (ch === ',' && !inQuotes){
        row.push(cur);
        cur = "";
      } else if (ch === '\n' && !inQuotes){
        row.push(cur);
        rows.push(row);
        row = [];
        cur = "";
      } else {
        cur += ch;
      }
    }
    // √∫ltima celda
    if (cur.length || row.length){
      row.push(cur);
      rows.push(row);
    }

    // headers
    const headers = rows.shift().map(h => h.trim().toLowerCase().replace(/^\uFEFF/, "")); // quita BOM
    return rows
      .filter(r => r.some(x => String(x).trim() !== ""))
      .map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
        return obj;
      });
  }

  function cleanUrl(u){
    // saca comillas si vinieran
    return String(u || "").trim().replace(/^"(.*)"$/, "$1").replace(/^'(.*)'$/, "$1");
  }

  async function loadProducts(){
    statusEl.textContent = "Cargando productos‚Ä¶";

    // cache-busting (Google a veces cachea)
    const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "v=" + Date.now();

    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("No se pudo leer el CSV (HTTP " + res.status + ")");

    const csv = await res.text();
    const rows = parseCSV(csv);

    products = rows
      .filter(r => String(r.activo).trim() === "1")
      .map(r => ({
        id: String(r.id || "").trim(),
        name: String(r.nombre || "").trim(),
        price: Number(String(r.precio || "0").replace(/[^\d]/g, "")), // por si alguien mete $ o puntos
        image: cleanUrl(r.imagen)
      }))
      .filter(p => p.id && p.name && Number.isFinite(p.price));

    // limpia pending de productos que ya no existan
    const ids = new Set(products.map(p => p.id));
    Object.keys(pending).forEach(id => { if (!ids.has(id)) delete pending[id]; });
    Object.keys(cart).forEach(id => { if (!ids.has(id)) delete cart[id]; });

    statusEl.textContent = "Productos cargados ‚úî";
    renderProducts();
    renderCart();
  }

  // ===== RENDER =====
  function renderProducts(){
    productsEl.innerHTML = "";

    products.forEach(p => {
      const pend = pending[p.id] || 0;
      const inCart = cart[p.id] || 0;

      const el = document.createElement("div");
      el.className = "product";

      el.innerHTML = `
        <img src="${p.image}" alt="${p.name}" onerror="this.style.display='none'">
        <div class="product-name">${p.name}</div>
        <div class="product-price">${money(p.price)}</div>

        <div class="qty">
          <button type="button" data-act="pendMinus" data-id="${p.id}">‚àí</button>
          <span>${pend}</span>
          <button type="button" data-act="pendPlus" data-id="${p.id}">+</button>
        </div>

        <button class="add" type="button" data-act="addToCart" data-id="${p.id}">
          AGREGAR AL CARRITO
        </button>

        <div class="hint">
          En carrito: <b>${inCart}</b> ‚Äî Eleg√≠ cantidad con +/‚àí y toc√° ‚ÄúAgregar‚Äù.
        </div>
      `;

      productsEl.appendChild(el);
    });
  }

  function renderCart(){
    cartList.innerHTML = "";
    let total = 0;

    // arma un mapa id->producto para seguridad
    const map = new Map(products.map(p => [p.id, p]));

    Object.keys(cart).forEach(id => {
      const q = cart[id] || 0;
      const p = map.get(id);
      if (!p || q <= 0) return;

      const sub = q * p.price;
      total += sub;

      const li = document.createElement("li");
      li.innerHTML = `<span>${p.name} x${q}</span><span>${money(sub)}</span>`;
      cartList.appendChild(li);
    });

    cartTotal.textContent = money(total);
  }

  // ===== ACTIONS =====
  function pendPlus(id){
    pending[id] = (pending[id] || 0) + 1;
    renderProducts();
  }
  function pendMinus(id){
    pending[id] = Math.max(0, (pending[id] || 0) - 1);
    renderProducts();
  }
  function addToCart(id){
    const q = pending[id] || 0;
    if (q <= 0) return;

    cart[id] = (cart[id] || 0) + q;
    pending[id] = 0;
    renderProducts();
    renderCart();
  }

  // Delegaci√≥n de eventos (para que no dependas de onclick en strings)
  productsEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const id = btn.getAttribute("data-id");
    const act = btn.getAttribute("data-act");
    if (!id || !act) return;

    if (act === "pendPlus") pendPlus(id);
    if (act === "pendMinus") pendMinus(id);
    if (act === "addToCart") addToCart(id);
  });

  buyBtn.onclick = () => {
    const ids = Object.keys(cart).filter(id => (cart[id] || 0) > 0);
    if (ids.length === 0){
      alert("Agreg√° productos al carrito");
      return;
    }

    const map = new Map(products.map(p => [p.id, p]));
    let msg = "Hola üëã quiero hacer una compra:%0A%0A";
    let total = 0;

    ids.forEach(id => {
      const p = map.get(id);
      const q = cart[id];
      if (!p) return;
      const sub = q * p.price;
      total += sub;
      msg += `‚Ä¢ ${p.name} x${q} ‚Äì ${money(sub)}%0A`;
    });

    msg += `%0Aüí∞ Total: ${money(total)}`;
    window.location.href = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(decodeURIComponent(msg))}`;
  };

  reloadBtn.onclick = async () => {
    try{
      await loadProducts();
    } catch(err){
      console.error(err);
      statusEl.textContent = "Error cargando productos. Revis√° el link CSV.";
      alert("Error cargando productos. Revis√° el link CSV publicado.");
    }
  };

  // ===== INIT =====
  (async () => {
    try{
      await loadProducts();
    } catch(err){
      console.error(err);
      statusEl.textContent = "Error cargando productos. Revis√° el link CSV.";
      alert("Error cargando productos. Revis√° el link CSV publicado.");
    }
  })();
</script>
</body>
</html>
