<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TABAQO â€“ Compra por WhatsApp</title>

  <style>
    :root{
      --bg:#000;
      --fg:#f5f5f5;
      --gold:#f6c000;
      --border:#222;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--fg);
    }

    /* Fondo de la app */
    body.has-bg{
      background-color:#000;
      background-repeat:no-repeat;
      background-position:center top;
      background-size:420px;
      background-attachment:fixed;
    }
    body.has-bg::before{
      content:"";
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.78);
      z-index:-1;
    }

    header{
      position:sticky;
      top:0;
      z-index:10;
      background:#000;
      border-bottom:1px solid var(--border);
    }
    .header-inner{
      max-width:1100px;
      margin:auto;
      padding:14px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-weight:900;
      letter-spacing:2px;
      color:var(--gold);
      gap:10px;
    }
    .cart-icon{
      display:flex;
      align-items:center;
      gap:10px;
      cursor:pointer;
      user-select:none;
    }
    .cart-count{
      background:var(--gold);
      color:#000;
      border-radius:999px;
      padding:2px 8px;
      font-size:12px;
      font-weight:900;
      min-width:26px;
      text-align:center;
    }

    .tabs{
      max-width:1100px;
      margin:0 auto;
      padding:16px 20px 0;
      display:flex;
      justify-content:center;
      gap:14px;
    }
    .tab-btn{
      background:#111;
      border:1px solid #333;
      color:#fff;
      padding:10px 16px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:1px;
    }
    .tab-btn.active{
      background:var(--gold);
      color:#000;
      border-color:var(--gold);
    }

    main{ max-width:1100px; margin:auto; padding:30px 20px 40px; }
    h2{ text-align:center; letter-spacing:2px; margin:18px 0 30px; }

    .section{ display:none; }
    .section.active{ display:block; }

    .products{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:40px;
    }
    .product{
      background:#fff;
      color:#000;
      border-radius:4px;
      padding:20px;
      text-align:center;
    }
    .product img{
      max-width:180px;
      height:auto;
      margin:0 auto 16px;
      display:block;
    }
    .product-name{ font-size:14px; margin-bottom:6px; font-weight:800; }
    .product-price{ font-size:14px; margin-bottom:16px; }

    .qty{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .qty button{
      width:32px;
      height:32px;
      border:1px solid #000;
      background:#fff;
      cursor:pointer;
      font-weight:900;
    }
    .qty span{ min-width:30px; text-align:center; font-weight:900; }
    .add{
      border:1px solid #000;
      background:#fff;
      padding:8px 14px;
      cursor:pointer;
      font-weight:900;
      width:100%;
    }
    .hint{ font-size:12px; opacity:.75; margin-top:10px; }

    /* ===== CARRITO EDITABLE ===== */
    .cart-wrap{
      max-width:780px;
      margin:0 auto;
      border-top:1px solid var(--border);
      padding-top:18px;
      background:url('https://i.imgur.com/XXXXX.jpg') center center/cover no-repeat; /* AquÃ­ agregas el link de la imagen */
      padding:40px;
      color:#fff;
    }

    .cart-items{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-bottom:18px;
    }
    .cart-row{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:12px;
      align-items:center;
      padding:12px;
      border:1px solid #1b1b1b;
      background:rgba(0,0,0,.35);
    }
    .cart-row-title{
      font-weight:800;
    }
    .cart-row-sub{
      opacity:.85;
      font-size:12px;
      margin-top:4px;
    }
    .cart-controls{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .cart-controls button{
      width:34px;
      height:34px;
      background:#111;
      color:#fff;
      border:1px solid #333;
      cursor:pointer;
      font-weight:900;
    }
    .cart-controls .q{
      min-width:26px;
      text-align:center;
      font-weight:900;
    }
    .cart-remove{
      background:#111;
      color:#fff;
      border:1px solid #333;
      cursor:pointer;
      font-weight:900;
      padding:8px 10px;
    }
    .cart-total{
      display:flex;
      justify-content:space-between;
      font-weight:900;
      margin-bottom:14px;
    }
    .buy{
      width:100%;
      padding:14px;
      background:var(--gold);
      border:none;
      font-weight:900;
      cursor:pointer;
    }
    .danger{
      width:100%;
      padding:12px;
      margin-top:10px;
      background:#111;
      color:#f5f5f5;
      border:1px solid #333;
      font-weight:900;
      cursor:pointer;
      border-radius:10px;
    }

    footer{ margin-top:40px; text-align:center; font-size:12px; opacity:.7; }
    .empty{
      text-align:center;
      opacity:.8;
      padding:18px 0;
      border:1px dashed #333;
      background:rgba(0,0,0,.2);
    }
  </style>
</head>

<body>

<header>
  <div class="header-inner">
    <div>TABAQO</div>

    <div class="cart-icon" id="cartIcon" title="Ir al carrito">
      ðŸ›’ <span class="cart-count" id="cartCount">0</span>
    </div>
  </div>
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="productos">PRODUCTOS</button>
  <button class="tab-btn" data-tab="combinados">COMBINADOS</button>
  <button class="tab-btn" data-tab="carrito">CARRITO</button>
</div>

<main>
  <section class="section active" id="productos">
    <h2>PRODUCTOS</h2>
    <div class="products" id="products"></div>
  </section>

  <section class="section" id="combinados">
    <h2>COMBINADOS</h2>
    <div class="products" id="combinadosList"></div>
    <div class="small-note">Se cargan desde el Google Sheet con id: Combinado1, Combinado2, etc.</div>
  </section>

  <section class="section" id="carrito">
    <h2>CARRITO</h2>

    <div class="cart-wrap">
      <div class="cart-items" id="cartItems"></div>

      <div class="cart-total">
        <span>Total</span>
        <span id="cartTotal">$0</span>
      </div>

      <button class="buy" id="buyBtn">INICIAR COMPRA POR WHATSAPP</button>
      <button class="danger" id="clearBtn" type="button">VACIAR CARRITO</button>
    </div>

    <footer>Compra directa por WhatsApp. No se solicitan datos personales.</footer>
  </section>
</main>

<script>
  // ===== CONFIG =====
  const WHATSAPP_PHONE = "5493515060159";
  const SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRXfu7as7scLMqrv48bHpytzzRwK0VlgPfVrOJ_3MsqnNBzfC0TRjsfO52HSsVjMkAzWJaGvcMh12Hv/pub?output=csv";

  let products = [];
  let combinados = [];
  let cart = {};    
  let pending = {};  

  const productsEl = document.getElementById("products");
  const combinadosEl = document.getElementById("combinadosList");

  const cartItemsEl = document.getElementById("cartItems");
  const cartTotalEl = document.getElementById("cartTotal");
  const buyBtn = document.getElementById("buyBtn");
  const clearBtn = document.getElementById("clearBtn");
  const cartCountEl = document.getElementById("cartCount");

  const fmt = (n) => Number(n||0).toLocaleString("es-AR");
  const money = (n) => `$${fmt(n)}`;

  function parseCSV(text){
    text = text.replace(/\r/g, "");
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++){
      const ch = text[i];
      if (ch === '"'){
        if (inQuotes && text[i+1] === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
      } else if (ch === ',' && !inQuotes){
        row.push(cur); cur = "";
      } else if (ch === '\n' && !inQuotes){
        row.push(cur); rows.push(row);
        row = []; cur = "";
      } else {
        cur += ch;
      }
    }
    if (cur.length || row.length){ row.push(cur); rows.push(row); }

    const headers = rows.shift().map(h => h.trim().toLowerCase().replace(/^\uFEFF/, ""));
    return rows
      .filter(r => r.some(x => String(x).trim() !== ""))
      .map(r => {
        const obj = {};
        headers.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
        return obj;
      });
  }

  function cleanUrl(u){
    return String(u || "").trim().replace(/^"(.*)"$/, "$1").replace(/^'(.*)'$/, "$1");
  }

  function isCombinadoId(id){
    return /^combinado\d+$/i.test(String(id||"").trim());
  }

  async function loadProducts(){
    const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "v=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error("No se pudo leer el CSV (HTTP " + res.status + ")");
    const rows = parseCSV(await res.text());

    const all = rows
      .filter(r => String(r.activo).trim() === "1")
      .map(r => ({
        id: String(r.id || "").trim(),
        name: String(r.nombre || "").trim(),
        price: Number(String(r.precio || "0").replace(/[^\d]/g, "")),
        image: cleanUrl(r.imagen)
      }))
      .filter(p => p.id && p.name && Number.isFinite(p.price));

    products = all.filter(p => !isCombinadoId(p.id));
    combinados = all.filter(p => isCombinadoId(p.id));

    const ids = new Set(all.map(p => p.id));
    Object.keys(cart).forEach(id => { if (!ids.has(id)) delete cart[id]; });
    Object.keys(pending).forEach(id => { if (!ids.has(id)) delete pending[id]; });

    renderProducts();
    renderCombinados();
    renderCart();
  }

  function productCard(p){
    const pend = pending[p.id] || 0;
    const inCart = cart[p.id] || 0;

    const el = document.createElement("div");
    el.className = "product";
    el.innerHTML = `
      ${p.image ? `<img src="${p.image}" alt="${p.name}" onerror="this.style.display='none'">` : ""}
      <div class="product-name">${p.name}</div>
      <div class="product-price">${money(p.price)}</div>

      <div class="qty">
        <button type="button" data-act="pendMinus" data-id="${p.id}">âˆ’</button>
        <span>${pend}</span>
        <button type="button" data-act="pendPlus" data-id="${p.id}">+</button>
      </div>

      <button class="add" type="button" data-act="addToCart" data-id="${p.id}">
        AGREGAR AL CARRITO
      </button>

      <div class="hint">En carrito: <b>${inCart}</b></div>
    `;
    return el;
  }

  function renderProducts(){
    productsEl.innerHTML = "";
    products.forEach(p => productsEl.appendChild(productCard(p)));
  }

  function renderCombinados(){
    combinadosEl.innerHTML = "";
    combinados.forEach(p => combinadosEl.appendChild(productCard(p)));
  }

  function cartCount(){
    return Object.values(cart).reduce((a,b)=>a+(b||0),0);
  }

  function renderCart(){
    const all = [...products, ...combinados];
    const map = new Map(all.map(p => [p.id, p]));

    cartItemsEl.innerHTML = "";
    let total = 0;

    const ids = Object.keys(cart).filter(id => (cart[id]||0) > 0);

    if (ids.length === 0){
      cartItemsEl.innerHTML = `<div class="empty">Tu carrito estÃ¡ vacÃ­o</div>`;
      cartTotalEl.textContent = money(0);
      cartCountEl.textContent = "0";
      return;
    }

    ids.forEach(id => {
      const p = map.get(id);
      if (!p) return;

      const q = cart[id];
      const sub = q * p.price;
      total += sub;

      const row = document.createElement("div");
      row.className = "cart-row";
      row.innerHTML = `
        <div>
          <div class="cart-row-title">${p.name}</div>
          <div class="cart-row-sub">${money(p.price)} c/u Â· Subtotal: <b>${money(sub)}</b></div>
        </div>

        <div class="cart-controls">
          <button type="button" data-act="dec" data-id="${id}">âˆ’</button>
          <div class="q">${q}</div>
          <button type="button" data-act="inc" data-id="${id}">+</button>
        </div>

        <button class="cart-remove" type="button" data-act="remove" data-id="${id}">ðŸ—‘</button>
      `;

      cartItemsEl.appendChild(row);
    });

    cartTotalEl.textContent = money(total);
    cartCountEl.textContent = String(cartCount());
  }

  function pendPlus(id){
    pending[id] = (pending[id] || 0) + 1;
    renderProducts(); renderCombinados();
  }
  function pendMinus(id){
    pending[id] = Math.max(0, (pending[id] || 0) - 1);
    renderProducts(); renderCombinados();
  }
  function addToCart(id){
    const q = pending[id] || 0;
    if (q <= 0) return;
    cart[id] = (cart[id] || 0) + q;
    pending[id] = 0;
    renderProducts(); renderCombinados();
    renderCart();
  }

  function clearCart(){
    cart = {};
    pending = {};
    renderProducts(); renderCombinados();
    renderCart();
  }

  cartItemsEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;
    const id = btn.getAttribute("data-id");
    const act = btn.getAttribute("data-act");
    if (!id || !act) return;

    if (act === "inc"){
      cart[id] = (cart[id] || 0) + 1;
      renderProducts(); renderCombinados();
      renderCart();
    }
    if (act === "dec"){
      cart[id] = Math.max(0, (cart[id] || 0) - 1);
      if (cart[id] === 0) delete cart[id];
      renderProducts(); renderCombinados();
      renderCart();
    }
    if (act === "remove"){
      delete cart[id];
      renderProducts(); renderCombinados();
      renderCart();
    }
  });

  const tabBtns = document.querySelectorAll(".tab-btn");
  const sections = document.querySelectorAll(".section");
  function openTab(name){
    tabBtns.forEach(b => b.classList.toggle("active", b.dataset.tab === name));
    sections.forEach(s => s.classList.toggle("active", s.id === name));
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  tabBtns.forEach(btn => btn.addEventListener("click", () => openTab(btn.dataset.tab)));
  document.getElementById("
