<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TABACO â€“ Compra por WhatsApp</title>

<style>
:root{
  --bg:#000;
  --fg:#f5f5f5;
  --gold:#f6c000;
  --border:#222;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background:var(--bg);
  color:var(--fg);
}
header{
  position:sticky;
  top:0;
  background:#000;
  border-bottom:1px solid var(--border);
  z-index:10;
}
.header-inner{
  max-width:1100px;
  margin:auto;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:800;
  letter-spacing:2px;
  color:var(--gold);
}
.cart-btn{
  background:#111;
  border:1px solid #333;
  border-radius:20px;
  color:var(--gold);
  padding:8px 14px;
  cursor:pointer;
  font-weight:900;
  display:flex;
  align-items:center;
  gap:8px;
}
.cart-btn .count{
  background:var(--gold);
  color:#000;
  border-radius:10px;
  padding:2px 7px;
  font-size:12px;
  font-weight:900;
  line-height:1.2;
  min-width:22px;
  text-align:center;
}
.tabs{
  display:flex;
  justify-content:center;
  gap:20px;
  padding:20px 0;
}
.tabs button{
  background:#111;
  border:1px solid #333;
  color:#fff;
  padding:10px 18px;
  cursor:pointer;
  font-weight:800;
  letter-spacing:1px;
}
.tabs button.active{
  background:var(--gold);
  color:#000;
}
main{max-width:1100px;margin:auto;padding:0 20px 40px}
.section{display:none}
.section.active{display:block}

.products{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:40px;
}
.product{
  background:#fff;
  color:#000;
  padding:20px;
  text-align:center;
}
.product img{
  max-width:160px;
  height:auto;
  margin:0 auto 12px;
  display:block;
}
.product-name{ font-size:14px; margin-bottom:6px; }
.product-price{ font-size:14px; margin-bottom:10px; }

.qty{
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  margin:10px 0;
}
.qty button{
  width:32px;
  height:32px;
  border:1px solid #000;
  background:#fff;
  cursor:pointer;
  font-weight:800;
}
.qty span{ min-width:30px; text-align:center; font-weight:900; }
.add{
  border:1px solid #000;
  background:#fff;
  padding:8px 14px;
  cursor:pointer;
  font-weight:900;
}
.hint{ font-size:12px; opacity:.75; margin-top:10px; }

.cart{
  max-width:700px;
  margin:0 auto;
}
.cart ul{list-style:none;padding:0;margin:0}
.cart li{
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
  border-bottom:1px solid #222;
  padding-bottom:10px;
}
.cart-left{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.cart-actions{
  display:flex;
  align-items:center;
  gap:8px;
}
.cart-actions button{
  width:30px;height:30px;
  border:1px solid #333;
  background:#111;
  color:#fff;
  cursor:pointer;
  font-weight:900;
}
.cart-total{
  display:flex;
  justify-content:space-between;
  font-weight:900;
  margin:18px 0;
}
.buy{
  width:100%;
  background:var(--gold);
  border:none;
  padding:14px;
  font-weight:900;
  cursor:pointer;
}
.danger{
  width:100%;
  margin-top:10px;
  background:#111;
  color:#fff;
  border:1px solid #333;
  padding:12px;
  cursor:pointer;
  font-weight:900;
}
.note{
  text-align:center;
  opacity:.75;
  font-size:12px;
  margin-top:14px;
}
</style>
</head>

<body>

<header>
  <div class="header-inner">
    <div>TABACO</div>
    <button class="cart-btn" id="cartTabBtn" type="button" title="Ver carrito">
      ðŸ›’ <span class="count" id="cartCount">0</span>
    </button>
  </div>
</header>

<div class="tabs">
  <button class="active" data-tab="productos">PRODUCTOS</button>
  <button data-tab="combinados">COMBINADOS</button>
  <button data-tab="carrito">CARRITO</button>
</div>

<main>
  <section id="productos" class="section active">
    <div class="products" id="products"></div>
  </section>

  <section id="combinados" class="section">
    <div class="products" id="combinadosList"></div>
  </section>

  <section id="carrito" class="section cart">
    <ul id="cartList"></ul>

    <div class="cart-total">
      <span>Total</span>
      <span id="cartTotal">$0</span>
    </div>

    <button class="buy" id="buyBtn">INICIAR COMPRA POR WHATSAPP</button>
    <button class="danger" id="clearBtn">BORRAR CARRITO</button>

    <div class="note">Compra directa por WhatsApp. No se solicitan datos personales.</div>
  </section>
</main>

<script>
const WHATSAPP_PHONE = "5493515060159";
const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRXfu7as7scLMqrv48bHpytzzRwK0VlgPfVrOJ_3MsqnNBzfC0TRjsfO52HSsVjMkAzWJaGvcMh12Hv/pub?output=csv";

let products = [];
let combinados = [];
let cart = {};     // {id: qty}
let pending = {};  // {id: qtyPendiente}

const $ = (id) => document.getElementById(id);
const money = (n) => `$${Number(n||0).toLocaleString("es-AR")}`;

// CSV robusto
function parseCSV(text){
  text = text.replace(/\r/g, "");
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++){
    const ch = text[i];

    if (ch === '"'){
      if (inQuotes && text[i+1] === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (ch === ',' && !inQuotes){
      row.push(cur);
      cur = "";
    } else if (ch === '\n' && !inQuotes){
      row.push(cur);
      rows.push(row);
      row = [];
      cur = "";
    } else {
      cur += ch;
    }
  }
  if (cur.length || row.length){
    row.push(cur);
    rows.push(row);
  }

  const headers = rows.shift().map(h => h.trim().toLowerCase().replace(/^\uFEFF/, ""));
  return rows
    .filter(r => r.some(x => String(x).trim() !== ""))
    .map(r => {
      const obj = {};
      headers.forEach((h, i) => obj[h] = (r[i] ?? "").trim());
      return obj;
    });
}

function cleanUrl(u){
  return String(u || "").trim().replace(/^"(.*)"$/, "$1").replace(/^'(.*)'$/, "$1");
}

async function load(){
  const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes("?") ? "&" : "?") + "v=" + Date.now();
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("No se pudo leer el CSV");

  const rows = parseCSV(await res.text());

  // columnas: id,nombre,precio,imagen,activo
  const all = rows
    .filter(r => String(r.activo).trim() === "1")
    .map(r => ({
      id: String(r.id || "").trim(),
      nombre: String(r.nombre || "").trim(),
      precio: Number(String(r.precio || "0").replace(/[^\d]/g, "")),
      imagen: cleanUrl(r.imagen)
    }))
    .filter(p => p.id && p.nombre && Number.isFinite(p.precio));

  products = all.filter(p => !/^combinado/i.test(p.id));
  combinados = all.filter(p => /^combinado/i.test(p.id));

  // limpiar carrito/pending de ids que ya no existen
  const ids = new Set(all.map(p => p.id));
  Object.keys(cart).forEach(id => { if (!ids.has(id)) delete cart[id]; });
  Object.keys(pending).forEach(id => { if (!ids.has(id)) delete pending[id]; });

  renderAll();
}

function card(p){
  const pend = pending[p.id] || 0;
  const inCart = cart[p.id] || 0;

  return `<div class="product">
    <img src="${p.imagen}" alt="${p.nombre}" onerror="this.style.display='none'">
    <div class="product-name">${p.nombre}</div>
    <div class="product-price">${money(p.precio)}</div>

    <div class="qty">
      <button type="button" onclick="chg('${p.id}',-1)">âˆ’</button>
      <span>${pend}</span>
      <button type="button" onclick="chg('${p.id}',1)">+</button>
    </div>

    <button class="add" type="button" onclick="add('${p.id}')">AGREGAR AL CARRITO</button>

    <div class="hint">En carrito: <b>${inCart}</b></div>
  </div>`;
}

function renderAll(){
  $("products").innerHTML = products.map(card).join("");
  $("combinadosList").innerHTML = combinados.map(card).join("");
  renderCart();
}

function chg(id, delta){
  pending[id] = (pending[id] || 0) + delta;
  if (pending[id] < 0) pending[id] = 0;
  renderAll();
}

function add(id){
  const q = pending[id] || 0;
  if (q <= 0) return;
  cart[id] = (cart[id] || 0) + q;
  pending[id] = 0;
  renderAll();
}

function cartChange(id, delta){
  cart[id] = (cart[id] || 0) + delta;
  if (cart[id] <= 0) delete cart[id];
  renderAll();
}

function renderCart(){
  const all = [...products, ...combinados];
  const map = new Map(all.map(p => [p.id, p]));

  let total = 0;
  let count = 0;

  const items = Object.keys(cart).filter(id => cart[id] > 0);

  $("cartList").innerHTML = items.map(id => {
    const p = map.get(id);
    const q = cart[id];
    if (!p) return "";
    const sub = q * p.precio;
    total += sub;
    count += q;

    return `<li>
      <div class="cart-left">
        <div><b>${p.nombre}</b></div>
        <div>${money(p.precio)} c/u</div>
      </div>
      <div class="cart-actions">
        <button type="button" onclick="cartChange('${id}',-1)">âˆ’</button>
        <b>${q}</b>
        <button type="button" onclick="cartChange('${id}',1)">+</button>
      </div>
    </li>`;
  }).join("");

  $("cartTotal").textContent = money(total);
  $("cartCount").textContent = count;
}

// Tabs
document.querySelectorAll(".tabs button").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tabs button").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    btn.classList.add("active");
    $(btn.dataset.tab).classList.add("active");
  };
});

// BotÃ³n carrito arriba abre pestaÃ±a carrito
$("cartTabBtn").onclick = () => {
  document.querySelector('.tabs button[data-tab="carrito"]').click();
};

$("clearBtn").onclick = () => {
  cart = {};
  pending = {};
  renderAll();
};

$("buyBtn").onclick = () => {
  const ids = Object.keys(cart).filter(id => cart[id] > 0);
  if (ids.length === 0){
    alert("El carrito estÃ¡ vacÃ­o");
    return;
  }

  const all = [...products, ...combinados];
  const map = new Map(all.map(p => [p.id, p]));

  let total = 0;
  let text = "Hola ðŸ‘‹ quiero hacer una compra:\n\n";

  ids.forEach(id => {
    const p = map.get(id);
    const q = cart[id];
    if (!p) return;
    const sub = q * p.precio;
    total += sub;
    text += `â€¢ ${p.nombre} x${q} â€“ ${money(sub)}\n`;
  });

  text += `\nðŸ’° Total: ${money(total)}`;
  window.location.href = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(text)}`;
};

load().catch(err=>{
  console.error(err);
  alert("No se pudieron cargar productos. RevisÃ¡ que el CSV estÃ© publicado.");
});
</script>
</body>
</html>
